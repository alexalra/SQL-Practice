--Business Question:

-- 1) How much money was generated in sales based on the unit price and quantities sold?

SELECT 
  SUM (UnitPrice * Quantity) AS SALES
FROM 
  InvoiceLine;


-- 1) Which genre generated most sales?

SELECT 
  SUM(I.UnitPrice * I.Quantity) AS SALES, 
  G.Name
FROM 
  InvoiceLine as I
JOIN
  Track as T 
ON 
  I.TrackId = T.TrackId
JOIN 
  Genre AS G
ON 
  T.GenreId = G.GenreId
GROUP BY 
  2
ORDER BY 
  1 DESC
LIMIT 
  1;

-- 1) How many genres generated less than 50 in sales?

WITH T1 AS 
  (SELECT 
    SUM(I.UnitPrice * I.Quantity) AS FUNDS, 
    G.Name AS NAME
  FROM 
    InvoiceLine as I
  JOIN 
    Track as T 
  ON 
    I.TrackId = T.TrackId
  JOIN 
    Genre AS G
  ON 
    T.GenreId = G.GenreId
  GROUP BY
    2), 

T2 AS 

  (SELECT 
    FUNDS, 
    NAME
  FROM 
    T1
  WHERE 
    FUNDS < 50
  GROUP BY 
    2
  ORDER BY 
    1 DESC)

SELECT 
  COUNT(T2.FUNDS) AS COUNT
FROM 
  T2
JOIN 
  T1
ON 
  T1.NAME = T2.NAME


-- 1) Who are the top 5 artists whose tracks occupy more bytes in this database? 

SELECT 
  A.name, 
  SUM(T.bytes) AS TOTAL_BYTES
FROM 
  artist as A
JOIN 
  album as AL 
ON 
  A.ArtistId=AL.ArtistId
JOIN 
  track as T
ON 
  T.AlbumID=AL.AlbumID
GROUP BY 
  A.name
ORDER BY 
  TOTAL_BYTES DESC
LIMIT
  5

-- 2) Who is the employe who generate more profits?

SELECT 
  SUM(I.total) TOTAL_SALES, 
  E.EmployeeId, 
  E.FirstName, 
  E.LastName
FROM 
  Invoice AS I
JOIN 
  Customer as C
ON 
  C.CustomerId = I.CustomerId
JOIN 
  Employee as E
ON 
  C.SupportRepId = E.EmployeeId
GROUP BY 
  E.EmployeeId
ORDER 
  BY TOTAL_SALES DESC
LIMIT
  1;

-- 3) What is the average duration of the tracks sold by the employee with higher sales?

To answer this question I created 2 subquerries, that I merged at the end into 1 single table.

The first subquerry (TABLE_1) returned the employee with higher sales.
The second subquerry (TABLE_2) returned the average duration of the tracks sold by every employee.

In the last section of the querry, I joined these 2 on the employee name, to see the average duration of the tracks sold by the employee with higher sales. 

WITH TABLE_1 AS 

  (SELECT 
    E.FirstName NAME, 
    E.LastName LAST_NAME,
    SUM(I.total) TOTAL_SALES, 
    E.EmployeeId EMPLOYEE_ID 
  FROM 
    Invoice AS I
  JOIN 
    Customer as C
  ON 
    C.CustomerId = I.CustomerId
  JOIN 
    Employee as E
  ON 
    C.SupportRepId = E.EmployeeId
  GROUP BY 
    4
  ORDER 
    BY 3 DESC
  LIMIT 
    1),

TABLE_2 AS 

  (SELECT 
    AVG(T.Milliseconds) AVERAGE_DURATION, 
    E.FirstName NAME,
    E.LastName LAST_NAME
  FROM 
    TRACK as T
  JOIN 
    InvoiceLine as IL 
  ON 
    T.TrackId = IL.TrackId
  JOIN 
    Invoice as I
  ON 
    IL.InvoiceId = I.InvoiceId
  JOIN 
    Customer as C
  ON 
    C.CustomerId = I.CustomerId
  JOIN 
    Employee as E
  ON 
    C.SupportRepId = E.EmployeeId
  GROUP BY 
    2)

SELECT  
  TABLE_1.NAME, 
  TABLE_1.LAST_NAME,
  TABLE_2.AVERAGE_DURATION
FROM 
  TABLE_1
JOIN 
  TABLE_2
ON 
  TABLE_1.NAME = TABLE_2.NAME AND  
  TABLE_1.LAST_NAME =  TABLE_2.LAST_NAME;



